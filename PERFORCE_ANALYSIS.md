# DSvn x Perforce: æ¶æ„èåˆåˆ†æ

## Perforce çš„æ ¸å¿ƒä¼˜åŠ¿

### 1. å¯æ‰©å±•æ€§æ¶æ„ ğŸ†

```
Perforce é›†ç¾¤æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      P4 Commit Server                        â”‚
â”‚                      (å•ä¸€æƒå¨æº)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                     â”‚               â”‚
                â–¼                                     â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  P4 Proxy 1       â”‚               â”‚  P4 Proxy 2       â”‚   â”‚  P4 Proxy N   â”‚
    â”‚  (è¾¹ç¼˜ç¼“å­˜)        â”‚               â”‚  (è¾¹ç¼˜ç¼“å­˜)        â”‚   â”‚  (è¾¹ç¼˜ç¼“å­˜)    â”‚
    â”‚  - åªè¯»æ“ä½œ        â”‚               â”‚  - åªè¯»æ“ä½œ        â”‚   â”‚  - åªè¯»æ“ä½œ    â”‚
    â”‚  - æ–‡ä»¶ç¼“å­˜        â”‚               â”‚  - æ–‡ä»¶ç¼“å­˜        â”‚   â”‚  - æ–‡ä»¶ç¼“å­˜    â”‚
    â”‚  - å…ƒæ•°æ®ç¼“å­˜      â”‚               â”‚  - å…ƒæ•°æ®ç¼“å­˜      â”‚   â”‚  - å…ƒæ•°æ®ç¼“å­˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                     â”‚
            â–¼                                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Local Team A     â”‚               â”‚  Local Team B     â”‚
    â”‚  (ä½å»¶è¿Ÿè®¿é—®)      â”‚               â”‚  (ä½å»¶è¿Ÿè®¿é—®)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§ï¼š**
- **è¾¹ç¼˜ä»£ç†**ï¼šéƒ¨ç½²åœ¨å„åœ°ï¼Œæä¾›ä½å»¶è¿Ÿåªè¯»è®¿é—®
- **æ™ºèƒ½ç¼“å­˜**ï¼šè‡ªåŠ¨ç¼“å­˜çƒ­æ•°æ®å’Œå…ƒæ•°æ®
- **æ•…éšœåˆ‡æ¢**ï¼šä»£ç†å¯ä»¥ç»§ç»­æœåŠ¡ç¼“å­˜æ•°æ®

**DSvn å¦‚ä½•å€Ÿé‰´ï¼š**
```rust
// è¾¹ç¼˜ä»£ç†æ¶æ„
pub struct EdgeProxy {
    local_cache: Arc<LocalStore>,      // æœ¬åœ°çƒ­æ•°æ®ç¼“å­˜
    metadata_cache: Arc<MetadataCache>, // å…ƒæ•°æ®ç¼“å­˜
    upstream: Arc<UpstreamClient>,     // è¿æ¥åˆ°ä¸»æœåŠ¡å™¨
}

impl EdgeProxy {
    // ä¼˜å…ˆä»æœ¬åœ°ç¼“å­˜è¯»å–
    pub async fn get_file(&self, path: &str, rev: u64) -> Result<Vec<u8>> {
        if let Some(data) = self.local_cache.get(path, rev).await? {
            return Ok(data);
        }

        // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»ä¸Šæ¸¸è·å–å¹¶ç¼“å­˜
        let data = self.upstream.get_file(path, rev).await?;
        self.local_cache.put(path, rev, &data).await?;
        Ok(data)
    }
}
```

### 2. æµå¼ä¼ è¾“å’Œå¤§æ–‡ä»¶å¤„ç† ğŸš€

**Perforce çš„åšæ³•ï¼š**
```python
# P4 æ”¯æŒæµå¼ä¼ è¾“å¤§æ–‡ä»¶
p4 print //depot/large/file.bin > output.bin

# ç‰¹æ€§ï¼š
# - åˆ†å—ä¼ è¾“ï¼ˆä¸å ç”¨å†…å­˜ï¼‰
# - æ–­ç‚¹ç»­ä¼ 
# - å¢é‡ä¼ è¾“ï¼ˆåªä¼ è¾“å˜åŒ–çš„éƒ¨åˆ†ï¼‰
# - å‹ç¼©ä¼ è¾“
```

**DSvn å®ç°ï¼š**
```rust
use tokio::io::AsyncBufReadExt;

pub async fn stream_file(
    &self,
    path: &str,
    rev: u64,
) -> impl Stream<Item = Result<Bytes>> {
    async_stream::stream! {
        // åˆ†å—è¯»å–å¯¹è±¡
        let object_id = self.resolve_path(path, rev).await?;
        let mut reader = self.store.get_streaming(object_id).await?;

        // æµå¼è¾“å‡ºï¼Œä¸å ç”¨å†…å­˜
        while let Some(chunk) = reader.next_chunk().await? {
            yield Ok(chunk);
        }
    }
}
```

**ä¼˜åŠ¿ï¼š**
- å¯ä»¥å¤„ç† TB çº§æ–‡ä»¶
- å†…å­˜å ç”¨æ’å®šï¼ˆä¸ç®¡æ–‡ä»¶å¤šå¤§ï¼‰
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 

### 3. æ™ºèƒ½åˆ†å±‚å’Œç¼“å­˜ç­–ç•¥ ğŸ§ 

```
Perforce ç¼“å­˜å±‚æ¬¡:

L1: å®¢æˆ·ç«¯å·¥ä½œåŒº
    â””â”€ å®Œæ•´æ–‡ä»¶å‰¯æœ¬

L2: P4 Proxy
    â”œâ”€ å…ƒæ•°æ®ç¼“å­˜ï¼ˆè·¯å¾„ â†’ ç‰ˆæœ¬æ˜ å°„ï¼‰
    â”œâ”€ çƒ­æ–‡ä»¶ç¼“å­˜ï¼ˆæœ€è¿‘è®¿é—®çš„æ–‡ä»¶ï¼‰
    â””â”€ å¢é‡ç¼“å­˜ï¼ˆæ–‡ä»¶å·®å¼‚ï¼‰

L3: Commit Server
    â”œâ”€ æœ€è¿‘ç‰ˆæœ¬ï¼ˆSSDï¼‰
    â”œâ”€ å†å²ç‰ˆæœ¬ï¼ˆHDDï¼‰
    â””â”€ å½’æ¡£å­˜å‚¨ï¼ˆå†·å­˜å‚¨ï¼‰
```

**DSvn æ”¹è¿›ï¼š**
```rust
pub struct SmartCache {
    // L1: å†…å­˜ç¼“å­˜ï¼ˆæœ€çƒ­æ•°æ®ï¼‰
    hot_lru: Arc<Mutex<LruCache<ObjectId, Bytes>>>,

    // L2: æœ¬åœ° SSD ç¼“å­˜
    ssd_cache: Arc<SsdCache>,

    // L3: é¢„æµ‹æ€§é¢„åŠ è½½
    prefetcher: Arc<Prefetcher>,
}

impl SmartCache {
    // é¢„æµ‹ä¸‹ä¸€ä¸ªéœ€è¦çš„æ–‡ä»¶
    pub async fn prefetch_related(&self, path: &str) {
        // åˆ†æè®¿é—®æ¨¡å¼
        let pattern = self.access_analyzer.analyze(path);

        // é¢„åŠ è½½å¯èƒ½çš„æ–‡ä»¶
        for likely_path in pattern.predict_next() {
            let _ = self.get_file(&likely_path).await;
        }
    }
}
```

### 4. å¹¶è¡Œæäº¤å’Œäº‹åŠ¡å¤„ç† âš¡

**Perforce çš„ç‰¹æ€§ï¼š**
- å¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶æäº¤
- æœåŠ¡å™¨ç«¯ä¸²è¡ŒåŒ–æäº¤
- æ”¯æŒæ–‡ä»¶çº§é”å®š

**DSvn æ”¹è¿›ï¼š**
```rust
pub struct TransactionManager {
    pending: Arc<RwLock<HashMap<TransactionId, PendingCommit>>>,
    file_locks: Arc<Mutex<HashMap<String, LockOwner>>>,
}

impl TransactionManager {
    // å¼€å§‹äº‹åŠ¡ï¼ˆå¹¶è¡Œï¼‰
    pub async fn begin_transaction(&self) -> TransactionId {
        let id = TransactionId::new();
        self.pending.write().await.insert(id, PendingCommit::new());
        id
    }

    // æäº¤äº‹åŠ¡ï¼ˆä¸²è¡ŒåŒ–ï¼‰
    pub async fn commit(&self, id: TransactionId) -> Result<u64> {
        // è·å–å…¨å±€å†™é”
        let _guard = self.commit_lock.lock().await;

        // åº”ç”¨å˜æ›´
        let mut pending = self.pending.write().await;
        let commit = pending.remove(&id).unwrap();

        // åˆ›å»ºæ–°ç‰ˆæœ¬
        let rev = self.apply_commit(commit).await?;

        Ok(rev)
    }
}
```

### 5. å…ƒæ•°æ®ä¼˜åŒ– ğŸ“Š

**Performance Helix Core çš„ä¼˜åŒ–ï¼š**
```cpp
// P4 çš„æ•°æ®åº“ schemaï¼ˆç®€åŒ–ï¼‰
// db.have: å®¢æˆ·ç«¯å·¥ä½œåŒºæ–‡ä»¶
// db.rev: ç‰ˆæœ¬å†å²
// db.changenum: å˜æ›´åˆ—è¡¨
// db.working: å·¥ä½œäº‹åŠ¡

// ç‰¹ç‚¹ï¼š
// - é«˜åº¦ä¼˜åŒ–çš„ B-tree ç´¢å¼•
// - å…ƒæ•°æ®å’Œæ•°æ®åˆ†ç¦»
// - æ”¯æŒèŒƒå›´æŸ¥è¯¢
```

**DSvn çš„å…ƒæ•°æ®è®¾è®¡ï¼š**
```rust
pub struct MetadataIndex {
    // è·¯å¾„ â†’ ç‰ˆæœ¬åˆ—è¡¨
    path_index: fjall::Tree,

    // ç‰ˆæœ¬ â†’ å˜æ›´æ–‡ä»¶åˆ—è¡¨
    rev_index: fjall::Tree,

    // ä½œè€… â†’ ç‰ˆæœ¬åˆ—è¡¨
    author_index: fjall::Tree,

    // æ—¶é—´ â†’ ç‰ˆæœ¬åˆ—è¡¨ï¼ˆæ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼‰
    time_index: fjall::Tree,
}

impl MetadataIndex {
    // å¿«é€ŸæŸ¥è¯¢ï¼š"è¿™ä¸ªæ–‡ä»¶åœ¨å“ªäº›ç‰ˆæœ¬ä¸­ä¿®æ”¹è¿‡ï¼Ÿ"
    pub async fn get_history(&self, path: &str) -> Result<Vec<u64>> {
        let key = format!("path:{}", path);
        let data = self.path_index.get(&key)?;
        Ok(bincode::deserialize(&data)?)
    }

    // å¿«é€ŸæŸ¥è¯¢ï¼š"æŸä¸ªæ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰æäº¤"
    pub async fn get_commits_in_range(
        &self,
        start: i64,
        end: i64,
    ) -> Result<Vec<Commit>> {
        // èŒƒå›´æ‰«æ
        self.time_index.prefix_iter(&start.to_be_bytes())
            .map(|entry| self.load_commit(entry))
            .collect()
    }
}
```

## èåˆæ¶æ„ï¼šDSvn 2.0

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       SVN å®¢æˆ·ç«¯                              â”‚
â”‚                  (svn, TortoiseSVN, etc.)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ HTTP/WebDAV
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DSvn Edge Proxy (å¯é€‰)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æœ¬åœ°ç¼“å­˜å±‚                                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ çƒ­æ–‡ä»¶ç¼“å­˜ (LRU, 10GB)                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ å…ƒæ•°æ®ç¼“å­˜ (è·¯å¾„ â†’ ç‰ˆæœ¬)                            â”‚  â”‚
â”‚  â”‚  â””â”€ å¢é‡ç¼“å­˜ (diffs)                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  é¢„æµ‹æ€§é¢„åŠ è½½                                            â”‚  â”‚
â”‚  â”‚  â””â”€ åŸºäºè®¿é—®æ¨¡å¼é¢„å–ç›¸å…³æ–‡ä»¶                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ (ç¼“å­˜æœªå‘½ä¸­)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DSvn Commit Server                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åè®®å±‚ (WebDAV/DeltaV)                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  äº‹åŠ¡ç®¡ç†å™¨                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ å¹¶è¡Œäº‹åŠ¡å¼€å§‹                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ ä¸²è¡ŒåŒ–æäº¤                                          â”‚  â”‚
â”‚  â”‚  â””â”€ å†²çªæ£€æµ‹                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å…ƒæ•°æ®å±‚                                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ è·¯å¾„ç´¢å¼• (Fjall)                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ ç‰ˆæœ¬ç´¢å¼•                                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ ä½œè€…ç´¢å¼•                                            â”‚  â”‚
â”‚  â”‚  â””â”€ æ—¶é—´ç´¢å¼•                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å¯¹è±¡å­˜å‚¨å±‚                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  Hot        â”‚  â”‚  Warm       â”‚  â”‚  Cold       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  (Fjall)    â”‚  â”‚  (Packfiles)â”‚  â”‚  (Archive)  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  æœ€è¿‘çš„     â”‚  â”‚  å‹ç¼©çš„     â”‚  â”‚  æ·±åº¦å†å²   â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ”¹è¿›ç‚¹

#### 1. è¾¹ç¼˜ä»£ç†ï¼ˆå¯é€‰ç»„ä»¶ï¼‰

```rust
// dsvn-proxy/src/main.rs
#[derive(Parser)]
struct ProxyArgs {
    #[arg(long)]
    upstream: String,           // ä¸»æœåŠ¡å™¨åœ°å€

    #[arg(long, default_value = "./cache")]
    cache_dir: String,          // æœ¬åœ°ç¼“å­˜ç›®å½•

    #[arg(long, default_value = "10GB")]
    cache_size: String,         // ç¼“å­˜å¤§å°

    #[arg(long)]
    listen: String,             // ç›‘å¬åœ°å€
}

#[tokio::main]
async fn main() -> Result<()> {
    let args = ProxyArgs::parse();

    // åˆ›å»ºä»£ç†æœåŠ¡å™¨
    let proxy = EdgeProxy::new(
        args.upstream,
        args.cache_dir,
        args.cache_size,
    ).await?;

    // å¯åŠ¨ä»£ç†
    proxy.serve(args.listen).await?;

    Ok(())
}
```

#### 2. æµå¼ä¼ è¾“

```rust
// dsvn-webdav/src/handlers.rs
pub async fn get_handler_streaming(
    req: Request<Incoming>,
    config: &Config,
) -> Result<Response<ResponseBody>, WebDavError> {
    let path = extract_path(req.uri())?;
    let rev = extract_revision(req.uri())?;

    // æµå¼è¯»å–æ–‡ä»¶
    let stream = storage.stream_file(path, rev).await?;

    // HTTP åˆ†å—ä¼ è¾“
    Ok(Response::builder()
        .header("Transfer-Encoding", "chunked")
        .body(ResponseBody::stream(stream))
        .unwrap())
}
```

#### 3. æ™ºèƒ½ç¼“å­˜ç­–ç•¥

```rust
// dsvn-core/src/cache.rs
pub struct SmartCache {
    hot: LruCache<ObjectId, Bytes>,
    ssd: SsdCache,
    access_pattern: AccessPatternAnalyzer,
}

impl SmartCache {
    // åŸºäºè®¿é—®æ¨¡å¼é¢„æµ‹
    pub async fn smart_prefetch(&self, path: &str, rev: u64) {
        // åˆ†æï¼šé€šå¸¸ä¿®æ”¹ a.c çš„å¼€å‘è€…ä¼šè®¿é—®ç›¸å…³æ–‡ä»¶
        let related = self.access_pattern.find_related(path);

        // é¢„åŠ è½½ç›¸å…³æ–‡ä»¶
        for file in related {
            let _ = self.get(file, rev).await;
        }
    }
}
```

#### 4. å¹¶è¡Œäº‹åŠ¡

```rust
// dsvn-core/src/transaction.rs
pub struct TransactionManager {
    transactions: DashMap<TransactionId, PendingTransaction>,
    commit_lock: Mutex<()>,
}

impl TransactionManager {
    // å¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å¼€å§‹äº‹åŠ¡
    pub fn begin(&self) -> TransactionId {
        let id = TransactionId::new();
        self.transactions.insert(id, PendingTransaction::new());
        id
    }

    // æäº¤æ—¶ä¸²è¡ŒåŒ–
    pub async fn commit(&self, id: TransactionId) -> Result<u64> {
        // è·å–å…¨å±€é”
        let _guard = self.commit_lock.lock().await;

        // åº”ç”¨äº‹åŠ¡
        let txn = self.transactions.remove(&id).unwrap();
        self.apply_txn(txn).await
    }
}
```

## æ€§èƒ½å¯¹æ¯”é¢„æµ‹

| åœºæ™¯ | SVN (FSFS) | DSvn v1.0 | DSvn v2.0 (P4é£æ ¼) |
|-----|-----------|----------|-------------------|
| **100 ä¸‡æ–‡ä»¶æ£€å‡º** | 30 åˆ†é’Ÿ | 2 åˆ†é’Ÿ | **30 ç§’** + è¾¹ç¼˜ç¼“å­˜ |
| **100 å¹¶å‘ç”¨æˆ·** | æ€§èƒ½ä¸‹é™ | å¯æ¥å— | **æ— å½±å“** |
| **å…¨çƒå›¢é˜Ÿè®¿é—®** | é«˜å»¶è¿Ÿ | ä¸­ç­‰ | **ä½å»¶è¿Ÿ** (è¾¹ç¼˜ä»£ç†) |
| **å¤§æ–‡ä»¶(10GB)æ£€å‡º** | å†…å­˜æº¢å‡º | æ…¢ | **æµå¼ï¼ŒO(1)å†…å­˜** |
| **çƒ­æ–‡ä»¶è®¿é—®** | ç£ç›˜ I/O | çƒ­å­˜å‚¨ | **å†…å­˜ç¼“å­˜** |

## å®æ–½ä¼˜å…ˆçº§

### Phase 1: åŸºç¡€ï¼ˆå½“å‰ï¼‰
- âœ… åè®®å…¼å®¹
- âœ… å†…å®¹å¯»å€å­˜å‚¨
- âœ… åˆ†å±‚å­˜å‚¨

### Phase 2: P4 ä¼˜åŒ–ï¼ˆä¸‹ä¸€æ­¥ï¼‰
1. **æµå¼ä¼ è¾“** (é«˜ä¼˜å…ˆçº§)
   - æ”¯æŒå¤§æ–‡ä»¶
   - åˆ†å—ä¼ è¾“
   - æ–­ç‚¹ç»­ä¼ 

2. **æ™ºèƒ½ç¼“å­˜** (é«˜ä¼˜å…ˆçº§)
   - LRU çƒ­ç¼“å­˜
   - å…ƒæ•°æ®ç¼“å­˜
   - é¢„æµ‹æ€§é¢„åŠ è½½

3. **å¹¶è¡Œäº‹åŠ¡** (ä¸­ä¼˜å…ˆçº§)
   - å¹¶è¡Œäº‹åŠ¡å¼€å§‹
   - ä¸²è¡ŒåŒ–æäº¤
   - æ–‡ä»¶é”

### Phase 3: åˆ†å¸ƒå¼ï¼ˆæœªæ¥ï¼‰
1. **è¾¹ç¼˜ä»£ç†**
   - æœ¬åœ°ç¼“å­˜æœåŠ¡å™¨
   - æ™ºèƒ½è·¯ç”±
   - æ•…éšœåˆ‡æ¢

2. **é›†ç¾¤æ¨¡å¼**
   - ä¸»ä»å¤åˆ¶
   - è¯»å†™åˆ†ç¦»
   - è´Ÿè½½å‡è¡¡

## æ€»ç»“

Perforce çš„ä¼˜åŠ¿ï¼š
- âœ… åˆ†å¸ƒå¼æ¶æ„ï¼ˆè¾¹ç¼˜ä»£ç†ï¼‰
- âœ… æµå¼ä¼ è¾“ï¼ˆå¤§æ–‡ä»¶å¤„ç†ï¼‰
- âœ… æ™ºèƒ½ç¼“å­˜ï¼ˆå¤šå±‚ä¼˜åŒ–ï¼‰
- âœ… å¹¶è¡Œäº‹åŠ¡ï¼ˆé«˜å¹¶å‘ï¼‰

DSvn çš„ä¼˜åŠ¿ï¼š
- âœ… åè®®å…¼å®¹ï¼ˆSVN å®¢æˆ·ç«¯ï¼‰
- âœ… å†…å®¹å¯»å€ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
- âœ… ç°ä»£ Rust å®ç°ï¼ˆå®‰å…¨ã€å¿«é€Ÿï¼‰
- âœ… å¼€æºï¼ˆå…è´¹ï¼‰

**èåˆæ–¹æ¡ˆ**ï¼š
> DSvn = SVN åè®® + P4 æ¶æ„ + Git å­˜å‚¨ + Rust å®ç°

è¿™åˆ›é€ äº†ä¸€ä¸ªï¼š
- å¯¹ç”¨æˆ·ï¼šé€æ˜çš„ï¼ˆä½¿ç”¨ç°æœ‰ SVN å®¢æˆ·ç«¯ï¼‰
- å¯¹è¿ç»´ï¼šå‹å¥½çš„ï¼ˆè¾¹ç¼˜ä»£ç†ã€æ™ºèƒ½ç¼“å­˜ï¼‰
- å¯¹ç¡¬ä»¶ï¼šé«˜æ•ˆçš„ï¼ˆæµå¼ã€åˆ†å±‚å­˜å‚¨ï¼‰
- å¯¹æœªæ¥ï¼šå¯æŒç»­çš„ï¼ˆå¼€æºã€ç°ä»£æŠ€æœ¯æ ˆï¼‰
