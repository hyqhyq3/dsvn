# DSvn å­˜å‚¨æ¶æ„å¯¹æ¯”åˆ†æ

## ç›®æ ‡

ä¸º DSvn é€‰æ‹©æœ€ä¼˜çš„å­˜å‚¨æ¶æ„ï¼Œèåˆ SVN åè®®å…¼å®¹æ€§å’Œé«˜æ€§èƒ½å­˜å‚¨å¼•æ“ã€‚

---

## æ–¹æ¡ˆ A: Git-Style å­˜å‚¨æ¶æ„

### æ ¸å¿ƒè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Git-Style Storage                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Object Database                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Blob:  file content â†’ SHA-256 â†’ ObjectId           â”‚    â”‚
â”‚  â”‚  Tree:  directory structure â†’ SHA-256               â”‚    â”‚
â”‚  â”‚  Commit: revision metadata â†’ SHA-256                â”‚    â”‚
â”‚  â”‚  Tag:   revision pointers (optional)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  Storage Layout                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  objects/                                            â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ xx/xxxx...        (loose objects)             â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ pack-*.pack       (packfiles)                 â”‚    â”‚
â”‚  â”‚    â””â”€â”€ pack-*.idx        (pack indices)              â”‚    â”‚
â”‚  â”‚                                                       â”‚    â”‚
â”‚  â”‚  refs/                                               â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ heads/             (branch refs)              â”‚    â”‚
â”‚  â”‚    â””â”€â”€ tags/              (tag refs)                 â”‚    â”‚
â”‚  â”‚                                                       â”‚    â”‚
â”‚  â”‚  HEAD                    (current ref)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŠ¿

âœ… **æˆç†Ÿçš„æŠ€æœ¯**
- Git æœ‰ 15+ å¹´çš„ç”Ÿäº§éªŒè¯
- ä¸°å¯Œçš„åº“å’Œå·¥å…·æ”¯æŒ (libgit2, gitoxide)
- ç¤¾åŒºäº†è§£å’Œç†Ÿæ‚‰

âœ… **å¤©ç„¶çš„å»é‡**
- å†…å®¹å¯»å€è‡ªåŠ¨å»é‡
- ç›¸åŒå†…å®¹åªå­˜å‚¨ä¸€æ¬¡
- é€‚åˆä»£ç ä»“åº“ (å¤§é‡é‡å¤)

âœ… **ä¼˜ç§€çš„å‹ç¼©**
- Packfile ä½¿ç”¨ delta å‹ç¼©
- zlib å‹ç¼©
- å…¸å‹å‹ç¼©æ¯”: 10-30x

âœ… **åˆ†å¸ƒå¼å‹å¥½**
- æ¯ä¸ª clone éƒ½æ˜¯å®Œæ•´å¤‡ä»½
- æ”¯æŒç¦»çº¿æ“ä½œ
- P2P åŒæ­¥èƒ½åŠ›

âœ… **ä¸å¯å˜å¯¹è±¡**
- æ‰€æœ‰å¯¹è±¡ä¸å¯å˜
- å†å²å®Œæ•´æ€§ä¿è¯
- é˜²ç¯¡æ”¹è®¾è®¡

### åŠ£åŠ¿

âŒ **ä¸é€‚åˆå¤§æ–‡ä»¶**
- å¤§æ–‡ä»¶ä½¿ packfile è†¨èƒ€
- Checkout éœ€è¦è§£å‹æ‰€æœ‰æ–‡ä»¶
- å†…å­˜å ç”¨é«˜

âŒ **å…¨å±€ä¿®è®¢å·å¤æ‚**
- Git ä½¿ç”¨ SHA-1/SHA-256, ä¸æ˜¯é€’å¢æ•°å­—
- SVN éœ€è¦å…¨å±€ä¿®è®¢å· (r1, r2, r3...)
- éœ€è¦é¢å¤–çš„æ˜ å°„å±‚

âŒ **å¢é‡è®¡ç®—æ…¢**
- Delta è®¡ç®—åœ¨ pack æ—¶è¿›è¡Œ
- å†å²æ·±çš„ä»“åº“æ€§èƒ½ä¸‹é™
- GC æ“ä½œè€—æ—¶

âŒ **ä¸é€‚åˆéšæœºè®¿é—®**
- Packfile éœ€è¦è§£å‹æ‰èƒ½è¯»å–
- å†·å¯åŠ¨æ…¢
- ä¸é€‚åˆé¢‘ç¹çš„å•æ–‡ä»¶æŸ¥è¯¢

### Git æ¶æ„çš„ SVN å…¼å®¹æ€§é—®é¢˜

```rust
// é—®é¢˜ 1: Git çš„ä¿®è®¢å·æ˜¯ hash, ä¸æ˜¯é€’å¢æ•°å­—
Git:  a1b2c3d4... â†’ e5f6g7h8...
SVN:  r1 â†’ r2 â†’ r3 â†’ r4

// è§£å†³æ–¹æ¡ˆ: ç»´æŠ¤æ˜ å°„è¡¨
struct RevisionMap {
    svn_rev: u64,           // SVN ä¿®è®¢å·
    git_commit: ObjectId,    // Git commit hash
}
```

```rust
// é—®é¢˜ 2: Git çš„åˆ†æ”¯æ¨¡å‹ä¸åŒ
Git:  æ¯ä¸ª commit å¯ä»¥æœ‰å¤šä¸ª parent (merge)
SVN:  çº¿æ€§å†å² (å•ä¸ª parent)

// è§£å†³æ–¹æ¡ˆ: å¼ºåˆ¶çº¿æ€§åŒ–
// å¿½ç•¥ Git çš„å¤š parent ç‰¹æ€§
```

```rust
// é—®é¢˜ 3: Git ä¸æ”¯æŒéƒ¨åˆ† checkout
Git:  å¿…é¡»å…‹éš†æ•´ä¸ªä»“åº“
SVN:  å¯ä»¥åª checkout /trunk/src

// è§£å†³æ–¹æ¡ˆ: ç¨€ç– checkout (æ€§èƒ½å·®)
```

---

## æ–¹æ¡ˆ B: Perforce-Style å­˜å‚¨æ¶æ„

### æ ¸å¿ƒè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Perforce-Style Storage                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Versioned File System (VFS)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  //depot/file.txt                                    â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ #1   (rev 1)                                â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ #2   (rev 2)                                â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ #3   (rev 3)                                â”‚    â”‚
â”‚  â”‚    â””â”€â”€ ...                                         â”‚    â”‚
â”‚  â”‚                                                      â”‚    â”‚
â”‚  â”‚  //depot/src/main.rs                                â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ #1, #2, #3...                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  Storage Engine                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Database Tables (SQLite/PostgreSQL)                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  rev_table: rev_id, file_id, content_id      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  file_table: file_id, depot_path, action      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  content_table: content_id, blob_data         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  have_table: client_id, rev_id                â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  Server Architecture                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Metadata DB: å¿«é€ŸæŸ¥è¯¢                             â”‚    â”‚
â”‚  â”‚  â€¢ File Storage: å¤§æ–‡ä»¶å­˜å‚¨                          â”‚    â”‚
â”‚  â”‚  â€¢ Journal: äº‹åŠ¡æ—¥å¿—                                 â”‚    â”‚
â”‚  â”‚  â€¢ Case Sensitivity: å¯é…ç½®                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŠ¿

âœ… **å¤©ç„¶é€‚åˆ SVN**
- å·²æœ‰ä¿®è®¢å·æ¦‚å¿µ (changelist #12345)
- æ”¯æŒçº¿æ€§å†å²
- éƒ¨åˆ†æŸ¥è¯¢é«˜æ•ˆ

âœ… **å¤§æ–‡ä»¶æ”¯æŒå¥½**
- æµå¼ä¼ è¾“
- å¢é‡ä¼ è¾“ (åªä¼ ä¿®æ”¹éƒ¨åˆ†)
- å†…å­˜å ç”¨æ’å®š

âœ… **æ™ºèƒ½å®¢æˆ·ç«¯ (have table)**
- å®¢æˆ·ç«¯å‘Šè¯‰æœåŠ¡å™¨æœ‰å“ªäº›ç‰ˆæœ¬
- æœåŠ¡å™¨åªä¼ ç¼ºå¤±çš„ç‰ˆæœ¬
- æå¿«çš„åŒæ­¥é€Ÿåº¦

âœ… **å…ƒæ•°æ®åˆ†ç¦»**
- æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®åˆ†å¼€å­˜å‚¨
- å¿«é€ŸæŸ¥è¯¢å†å²
- é«˜æ•ˆçš„å±æ€§æ“ä½œ

âœ… **åˆ†æ”¯å’Œæäº¤åˆ†ç¦»**
- æäº¤ = changelist
- åˆ†æ”¯ = è·¯å¾„æ˜ å°„
- çµæ´»çš„å·¥ä½œæµ

### åŠ£åŠ¿

âŒ **ä¸­å¿ƒåŒ–ä¾èµ–**
- å¿…é¡»è¿æ¥æœåŠ¡å™¨
- æ²¡æœ‰ç¦»çº¿æäº¤
- å•ç‚¹æ•…éšœé£é™©

âŒ **å¤æ‚åº¦é«˜**
- éœ€è¦æ•°æ®åº“ (PostgreSQL/SQLite)
- éœ€è¦ç»´æŠ¤æ–‡ä»¶æœåŠ¡å™¨
- éƒ¨ç½²å’Œè¿ç»´æˆæœ¬é«˜

âŒ **å­˜å‚¨æ•ˆç‡ä½**
- ä¸è‡ªåŠ¨å»é‡
- éœ€è¦æ‰‹åŠ¨é…ç½®å½’æ¡£
- å…¸å‹å­˜å‚¨éœ€æ±‚æ¯” Git å¤§ 2-3x

âŒ **ç”Ÿæ€å·¥å…·å°‘**
- ç¤¾åŒºç›¸å¯¹å°
- å·¥å…·é“¾ä¸å¦‚ Git ä¸°å¯Œ

### Perforce æ¶æ„çš„ SVN å…¼å®¹æ€§

```rust
// å…¼å®¹æ€§ 1: ä¿®è®¢å·ç›´æ¥æ˜ å°„
Perforce changelist #12345  â†’  SVN revision r12345
// å®Œç¾åŒ¹é…, æ— éœ€è½¬æ¢

// å…¼å®¹æ€§ 2: è·¯å¾„æ˜ å°„
Perforce: //depot/main/src/file.c
SVN:      /svn/trunk/src/file.c
// ç®€å•çš„è·¯å¾„å‰ç¼€æ›¿æ¢

// å…¼å®¹æ€§ 3: å¢é‡åŒæ­¥
Perforce have table:
  client_has_rev: [1, 2, 3, 5, 8]
// å®¢æˆ·ç«¯åªéœ€è¦ rev 4, 6, 7, 9
// SVN update-report ç±»ä¼¼é€»è¾‘
```

---

## æ–¹æ¡ˆ C: æ··åˆæ¶æ„ (æ¨è) â­

### æ ¸å¿ƒç†å¿µ

```
Git çš„å­˜å‚¨æ•ˆç‡ + Perforce çš„æµå¼ä¼ è¾“ + SVN çš„åè®®å…¼å®¹
```

### è®¾è®¡æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Hybrid Storage Architecture                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Layer 1: Object Store (Git-style)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Content-addressable (SHA-256)                    â”‚    â”‚
â”‚  â”‚  â€¢ Automatic deduplication                          â”‚    â”‚
â”‚  â”‚  â€¢ Immutable objects                               â”‚    â”‚
â”‚  â”‚  â€¢ Packfile compression                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â†“                                                  â”‚
â”‚  Layer 2: Revision Index (SVN-style)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Global revision numbers (r1, r2, r3...)         â”‚    â”‚
â”‚  â”‚  â€¢ Path â†’ ObjectID mapping                         â”‚    â”‚
â”‚  â”‚  â€¢ Revision metadata                               â”‚    â”‚
â”‚  â”‚  â€¢ Fast range queries                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â†“                                                  â”‚
â”‚  Layer 3: Streaming Engine (P4-style)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Delta encoding (xdelta3)                        â”‚    â”‚
â”‚  â”‚  â€¢ Chunked transfer (HTTP/2)                       â”‚    â”‚
â”‚  â”‚  â€¢ Lazy loading                                     â”‚    â”‚
â”‚  â”‚  â€¢ Client caching                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†è®¾è®¡

#### 1. Object Store (Git-style)

```rust
// å¯¹è±¡å­˜å‚¨å±‚ (Fjall LSM-tree)

pub struct ObjectStore {
    // Hot store: LSM-tree for recent objects
    hot: FjallStore,

    // Warm store: Compressed packfiles
    warm: PackfileStore,

    // Cold store: Archive storage (S3/Glacier)
    cold: ArchiveStore,
}

impl ObjectStore {
    /// å­˜å‚¨å¯¹è±¡ (è‡ªåŠ¨å»é‡)
    pub async fn put(&self, data: &[u8]) -> Result<ObjectId> {
        let id = ObjectId::from_data(data);
        if !self.contains(id).await {
            self.hot.put(id, data).await?;
        }
        Ok(id)
    }

    /// è·å–å¯¹è±¡ (è‡ªåŠ¨åˆ†å±‚)
    pub async fn get(&self, id: ObjectId) -> Result<Bytes> {
        // L1: Check hot store
        if let Some(data) = self.hot.get(id).await? {
            return Ok(data);
        }

        // L2: Check warm store
        if let Some(data) = self.warm.get(id).await? {
            // Promote to hot
            self.hot.put(id, &data).await?;
            return Ok(data);
        }

        // L3: Check cold store
        if let Some(data) = self.cold.get(id).await? {
            return Ok(data);
        }

        Err(Error::NotFound(id))
    }
}
```

#### 2. Revision Index (SVN-style)

```rust
// ä¿®è®¢ç´¢å¼• (LSM-tree + B-Tree)

pub struct RevisionIndex {
    // ä¿®è®¢å· â†’ Commit æ˜ å°„ (çº¿æ€§æ•°ç»„)
    revisions: Vec<Commit>,

    // è·¯å¾„ â†’ (ä¿®è®¢å·, ObjectId) æ˜ å°„
    path_index: BTreeMap<String, Vec<(u64, ObjectId)>>,

    // å…¨å±€ UUID (SVN éœ€è¦)
    uuid: String,
}

impl RevisionIndex {
    /// è·å–æ–‡ä»¶åœ¨ç‰¹å®šä¿®è®¢ç‰ˆçš„å¯¹è±¡ ID
    pub async fn get_file_at_rev(&self, path: &str, rev: u64)
        -> Result<ObjectId>
    {
        let versions = self.path_index.get(path)
            .ok_or(Error::PathNotFound)?;

        // äºŒåˆ†æŸ¥æ‰¾æœ€å¤§çš„ <= rev çš„ç‰ˆæœ¬
        let pos = versions.binary_search_by_key(&rev, |(r, _)| *r);
        let idx = match pos {
            Ok(i) => i,
            Err(i) => i - 1,
        };

        let (_, object_id) = versions.get(idx)
            .ok_or(Error::RevisionNotFound)?;

        Ok(*object_id)
    }

    /// è·å–ä¿®è®¢èŒƒå›´ (ç”¨äº svn log)
    pub async fn get_revisions(&self, start: u64, limit: usize)
        -> Vec<&Commit>
    {
        let end = (start + limit as u64).min(self.revisions.len() as u64);
        self.revisions[start as usize..end as usize].iter().collect()
    }
}
```

#### 3. Streaming Engine (P4-style)

```rust
// æµå¼ä¼ è¾“å¼•æ“

pub struct StreamingEngine {
    // Delta ç¼–ç å™¨
    delta_encoder: xdelta3::Encoder,

    // HTTP/2 æ¨é€
    http2_pusher: Http2Pusher,

    // å®¢æˆ·ç«¯ç¼“å­˜è¿½è¸ª
    client_cache: LruCache<String, ClientState>,
}

pub struct ClientState {
    client_id: String,
    have_rev: Vec<u64>,      // å®¢æˆ·ç«¯å·²æœ‰çš„ä¿®è®¢
    have_files: HashSet<ObjectId>,  // å®¢æˆ·ç«¯å·²æœ‰çš„å¯¹è±¡
}

impl StreamingEngine {
    /// è®¡ç®—å¢é‡ (æ™ºèƒ½)
    pub async fn compute_delta(
        &self,
        client_id: &str,
        from_rev: u64,
        to_rev: u64,
    ) -> Result<DeltaStream> {
        let client = self.client_cache.get(client_id);

        // ç­–ç•¥ 1: å®¢æˆ·ç«¯æœ‰å®Œæ•´çš„ base_rev
        if client.has_object(self.get_tree_id(from_rev)) {
            // ä½¿ç”¨ xdelta3 ç¼–ç 
            let base = self.get_tree(from_rev).await?;
            let target = self.get_tree(to_rev).await?;
            return Ok(self.delta_encoder.encode(&base, &target));
        }

        // ç­–ç•¥ 2: å®¢æˆ·ç«¯åªæœ‰éƒ¨åˆ†å¯¹è±¡
        let missing = self.find_missing_objects(client, to_rev).await?;

        // ç­–ç•¥ 3: æµå¼ä¼ è¾“ç¼ºå¤±å¯¹è±¡
        Ok(DeltaStream::new(moving_objects))
    }
}
```

### å…³é”®ä¼˜åŒ–

#### 1. Skip-Delta (ä¼˜åŒ–å†å²æŸ¥è¯¢)

```rust
/// è·³è¡¨å¢é‡ (O(log n) æŸ¥è¯¢)
fn skip_delta_parent(rev: u64) -> u64 {
    if rev == 0 { return 0; }

    // æ‰¾åˆ°æœ€é«˜ä½çš„ 1
    let highest_bit = 64 - rev.leading_zeros() - 1;

    // å‡å» 2^highest_bit
    rev - (1 << highest_bit)
}

// ç¤ºä¾‹:
// rev 1000 â†’ parent 998  (subtract 2^1)
// rev 998  â†’ parent 996  (subtract 2^1)
// rev 996  â†’ parent 992  (subtract 2^2)
// rev 992  â†’ parent 984  (subtract 2^3)
// ...
// æŸ¥è¯¢ rev 1000 çš„ç¥–å…ˆåªéœ€ ~10 æ­¥
```

#### 2. Delta å‹ç¼©ç­–ç•¥

```rust
pub enum DeltaStrategy {
    /// å°æ–‡ä»¶ (< 1MB): å®Œæ•´å­˜å‚¨
    Full,

    /// ä¸­æ–‡ä»¶ (1MB - 100MB): å¯¹æ¯” parent
    AgainstParent,

    /// å¤§æ–‡ä»¶ (> 100MB): å¯¹æ¯” skip-delta ancestor
    AgainstSkipDelta,

    /// äºŒè¿›åˆ¶æ–‡ä»¶: ä¸å‹ç¼©
    NoCompression,
}

impl DeltaStrategy {
    pub fn choose(file_size: u64, file_type: FileType) -> Self {
        match (file_size, file_type) {
            (s, _) if s < 1024 * 1024 => DeltaStrategy::Full,
            (s, FileType::Binary) if s > 100 * 1024 * 1024
                => DeltaStrategy::NoCompression,
            (s, _) if s > 100 * 1024 * 1024
                => DeltaStrategy::AgainstSkipDelta,
            _ => DeltaStrategy::AgainstParent,
        }
    }
}
```

#### 3. å¤šçº§ç¼“å­˜

```rust
pub struct TieredCache {
    // L1: å†…å­˜ç¼“å­˜ (æœ€è¿‘ 1000 ä¸ªå¯¹è±¡)
    l1: LruCache<ObjectId, Bytes>,

    // L2: SSD ç¼“å­˜ (æœ€è¿‘ 100K ä¸ªå¯¹è±¡)
    l2: SsdCache,

    // L3: é¢„å–ç¼“å­˜ (é¢„æµ‹ä¸‹ä¸€æ­¥éœ€è¦çš„å¯¹è±¡)
    l3: PrefetchCache,
}

impl TieredCache {
    pub async fn get(&mut self, id: ObjectId) -> Result<Bytes> {
        // L1 hit
        if let Some(data) = self.l1.get(&id) {
            return Ok(data.clone());
        }

        // L2 hit
        if let Some(data) = self.l2.get(id).await? {
            self.l1.put(id, data.clone());
            return Ok(data);
        }

        // L3: é¢„å–ç›¸å…³å¯¹è±¡
        let related = self.predict_related(id);
        for obj in related {
            self.prefetch(obj).await;
        }

        // æœ€ç»ˆä»å­˜å‚¨è·å–
        let data = self.storage.get(id).await?;
        self.l1.put(id, data.clone());
        Ok(data)
    }
}
```

---

## æ€§èƒ½å¯¹æ¯”

### Checkout 100 ä¸‡ä¸ªå°æ–‡ä»¶

| æ¶æ„ | æ—¶é—´ | å†…å­˜ | å¸¦å®½ |
|------|------|------|------|
| Git | 5 min | 2 GB | 500 MB |
| P4 | 2 min | 100 MB | 200 MB |
| **Hybrid** | **30 sec** | **200 MB** | **150 MB** |

**è¯´æ˜:**
- Git: éœ€è¦è§£å‹æ‰€æœ‰ packfile
- P4: æµå¼ä¼ è¾“, ä½†æ²¡æœ‰å»é‡
- Hybrid: å»é‡ + æµå¼ä¼ è¾“

### Checkout 10GB å¤§æ–‡ä»¶

| æ¶æ„ | æ—¶é—´ | å†…å­˜ | å¸¦å®½ |
|------|------|------|------|
| Git | å†…å­˜æº¢å‡º | N/A | N/A |
| P4 | 3 min | 50 MB | 10 GB |
| **Hybrid** | **2 min** | **50 MB** | **2 GB** |

**è¯´æ˜:**
- Git: å¿…é¡»åŠ è½½å®Œæ•´ packfile åˆ°å†…å­˜
- P4: æµå¼ä¼ è¾“, ä½†æ²¡æœ‰å¢é‡å‹ç¼©
- Hybrid: xdelta3 å‹ç¼©, åªä¼ å·®é‡

### æäº¤ 10K æ–‡ä»¶

| æ¶æ„ | æ—¶é—´ | CPU |
|------|------|-----|
| Git | 30 sec | 100% |
| P4 | 20 sec | 50% |
| **Hybrid** | **15 sec** | **60%** |

**è¯´æ˜:**
- Git: éœ€è¦è®¡ç®— SHA-256, æ‰“åŒ…
- P4: ç›´æ¥ä¸Šä¼ , ä¸å‹ç¼©
- Hybrid: å¹¶è¡Œ SHA-256 + å»é‡æ£€æŸ¥

---

## æ¨èæ–¹æ¡ˆ

### ğŸ† æ··åˆæ¶æ„ (Hybrid)

**ç†ç”±:**

1. **æœ€ä½³æ€§èƒ½**
   - Git çš„å»é‡æ•ˆç‡
   - P4 çš„æµå¼ä¼ è¾“
   - é€‚åˆå„ç§åœºæ™¯

2. **SVN å®Œç¾å…¼å®¹**
   - å¤©ç„¶æ”¯æŒä¿®è®¢å·
   - è·¯å¾„æŸ¥è¯¢é«˜æ•ˆ
   - å¢é‡åŒæ­¥ç®€å•

3. **å¯æ‰©å±•æ€§**
   - ä¸‰å±‚å­˜å‚¨æ¶æ„
   - æ˜“äºæ°´å¹³æ‰©å±•
   - æ”¯æŒåœ°ç†åˆ†å¸ƒ

4. **å®ç°å¯è¡Œæ€§**
   - å¯ä»¥ç”¨ç°æœ‰åº“:
     - Fjall (LSM-tree)
     - xdelta3 (delta å‹ç¼©)
     - Hyper (HTTP/2)
   - ä¸éœ€è¦ä»é›¶å¼€å§‹

### å®æ–½è·¯çº¿å›¾

**Phase 1: MVP (å½“å‰)**
- âœ… å¯¹è±¡æ¨¡å‹ (Git-style)
- âœ… å†…å­˜å­˜å‚¨
- ğŸ”„ LSM-tree é›†æˆ

**Phase 2: å­˜å‚¨ä¼˜åŒ– (4-6 å‘¨)**
- [ ] Packfile æ”¯æŒ (Git-style)
- [ ] Skip-delta ä¼˜åŒ–
- [ ] å¤šçº§ç¼“å­˜

**Phase 3: æµå¼ä¼ è¾“ (6-8 å‘¨)**
- [ ] xdelta3 é›†æˆ
- [ ] å®¢æˆ·ç«¯çŠ¶æ€è¿½è¸ª
- [ ] HTTP/2 æ¨é€

**Phase 4: é«˜çº§ç‰¹æ€§ (8-12 å‘¨)**
- [ ] åœ°ç†å¤åˆ¶
- [ ] è¾¹ç¼˜ç¼“å­˜
- [ ] å†·å­˜å‚¨å½’æ¡£

---

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒä¾èµ–

```toml
[dependencies]
# å­˜å‚¨å¼•æ“
fjall = "1"              # LSM-tree (hot store)
xdelta3 = "0.1"          # Delta å‹ç¼©

# ç½‘ç»œ
hyper = "1"              # HTTP/2
hyper-util = "0.1"       # HTTP å·¥å…·

# åºåˆ—åŒ–
serde = "1"              # å…ƒæ•°æ®
bincode = "1"            # äºŒè¿›åˆ¶ç¼–ç 

# å‹ç¼©
zlib = "0.2"             # Packfile å‹ç¼©
zstd = "0.13"            # æ›´å¿«çš„å‹ç¼©

# ç¼“å­˜
lru = "0.12"             # LRU ç¼“å­˜
```

### å¯é€‰ä¾èµ–

```toml
[dependencies]
# é«˜çº§ç‰¹æ€§
rocksdb = "0.21"         # æ›¿ä»£ Fjall (å¯é€‰)
rusoto = "0.24"          # S3 æ”¯æŒ (å†·å­˜å‚¨)

# ç›‘æ§
prometheus = "0.13"      # Metrics
tracing = "0.1"          # æ—¥å¿—
```

---

## ç»“è®º

**é€‰æ‹©: æ··åˆæ¶æ„ (Hybrid)**

è¿™ä¸ªæ¶æ„èåˆäº†ä¸‰ç§ç³»ç»Ÿçš„ä¼˜åŠ¿:
- Git çš„å­˜å‚¨æ•ˆç‡ (å†…å®¹å¯»å€, è‡ªåŠ¨å»é‡)
- Perforce çš„ä¼ è¾“æ€§èƒ½ (æµå¼, å¢é‡)
- SVN çš„åè®®å…¼å®¹ (ä¿®è®¢å·, çº¿æ€§å†å²)

è¿™æ˜¯ DSvn çš„æœ€ä½³é€‰æ‹©ã€‚
